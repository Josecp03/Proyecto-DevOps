name: Ansible - Backups

on:
  push:
    branches:
      - main
    paths:
      - 'ansible/playbooks/bkp.yml'
      - 'ansible/roles/backup/**'
      - 'ansible/inventories/dev/group_vars/backups.yml'
  workflow_dispatch:

jobs:
  bkp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: |
          pip install ansible-core==2.17.8 ansible-lint
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ANSIBLE_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H vm-bkp >> ~/.ssh/known_hosts
      - name: Vault password
        run: echo "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > ~/.vault_pass.txt
      - name: Install requirements
        working-directory: ansible
        run: ansible-galaxy collection install -r requirements.yml
      - name: Run Backup Playbook
        working-directory: ansible
        run: ansible-playbook -i inventories/dev/inventory.ini playbooks/bkp.yml --vault-password-file ~/.vault_pass.txt
